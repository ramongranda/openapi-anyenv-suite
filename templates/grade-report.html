<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenAPI Grade Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-900 text-slate-100">
    <div class="max-w-6xl mx-auto p-6">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <img src="{{logoUrl}}" alt="openapi-anyenv-suite" class="w-10 h-10 rounded-full ring-1 ring-slate-700 {{logoClass}}" />
          <h1 class="text-2xl font-semibold">OpenAPI Grade Report</h1>
          <p class="text-slate-400 text-sm">Generated by openapi-anyenv-suite</p>
        </div>
        <div class="flex items-center gap-3">
          <label for="compactToggle" class="text-sm text-slate-300">Compact (errors only)</label>
          <button id="compactToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-700 transition-colors">
            <span class="inline-block h-4 w-4 translate-x-1 rounded-full bg-white transition-transform"></span>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-12 gap-4 mt-4">
        <div class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="space-y-2">
            <div>
              <div class="text-xs text-slate-400">Numeric Score</div>
              <div class="text-3xl font-bold">{{score}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Letter</div>
              <div><span class="inline-block px-3 py-1 rounded-full bg-sky-900/60 text-sky-300 font-semibold">{{letter}}</span></div>
            </div>
          </div>
        </div>

        <div class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-slate-400">Spectral Errors</div>
              <div class="inline-block px-2 py-1 rounded bg-rose-900/50 text-rose-300 font-semibold">{{spectralErrors}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Spectral Warnings</div>
              <div class="inline-block px-2 py-1 rounded bg-amber-900/50 text-amber-300 font-semibold">{{spectralWarnings}}</div>
            </div>
          </div>
        </div>

        <div class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-slate-400">Redocly Errors</div>
              <div class="inline-block px-2 py-1 rounded bg-rose-900/50 text-rose-300 font-semibold">{{redoclyErrors}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Redocly Warnings</div>
              <div class="inline-block px-2 py-1 rounded bg-amber-900/50 text-amber-300 font-semibold">{{redoclyWarnings}}</div>
            </div>
          </div>
        </div>
      </div>

      <section class="bg-slate-800/80 border border-slate-700 rounded-lg p-4 mt-4">
        <h2 class="text-sm text-slate-300 mb-2">Heuristics</h2>
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 text-sm">
          <div><div class="text-slate-400 text-xs">Operations</div><div class="font-semibold">{{operations}}</div></div>
          <div><div class="text-slate-400 text-xs">Summaries</div><div class="font-semibold">{{summaryPct}}</div></div>
          <div><div class="text-slate-400 text-xs">Descriptions</div><div class="font-semibold">{{descPct}}</div></div>
          <div><div class="text-slate-400 text-xs">Has 4xx</div><div class="font-semibold">{{with4xxPct}}</div></div>
          <div><div class="text-slate-400 text-xs">OpId Unique</div><div class="font-semibold">{{opIdUniquePct}}</div></div>
          <div><div class="text-slate-400 text-xs">Title</div><div class="font-semibold">{{hasTitle}}</div></div>
          <div><div class="text-slate-400 text-xs">Version</div><div class="font-semibold">{{hasVersion}}</div></div>
          <div><div class="text-slate-400 text-xs">Servers</div><div class="font-semibold">{{hasServers}}</div></div>
          <div><div class="text-slate-400 text-xs">Security Schemes</div><div class="font-semibold">{{hasSecSchemes}}</div></div>
          <div><div class="text-slate-400 text-xs">Bonus</div><div class="font-semibold">{{bonus}}</div></div>
        </div>
      </section>

      <section class="bg-slate-800/80 border border-slate-700 rounded-lg p-4 mt-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-sm text-slate-300">AI Tools</h2>
          <div class="flex items-center gap-2">
            <button id="selErrors" class="text-xs px-2 py-1 rounded bg-rose-900/40 border border-rose-700/50">Select errors</button>
            <button id="selWarnings" class="text-xs px-2 py-1 rounded bg-amber-900/40 border border-amber-700/50">Select warnings</button>
            <button id="clearSel" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600">Clear</button>
            <label class="text-xs text-slate-300 ml-2 inline-flex items-center gap-1"><input id="incHeur" type="checkbox" class="align-middle" checked /> Include heuristics</label>
          </div>
        </div>
        <div class="mt-3 flex flex-wrap items-center gap-2">
          <button id="genPrompt" class="px-3 py-1 rounded bg-sky-700 hover:bg-sky-600">Generate AI Prompt</button>
          <button id="copyPrompt" class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600" disabled>Copy</button>
          <span id="copyStatus" class="text-xs text-slate-400"></span>
        </div>
        <div id="promptBoxWrap" class="mt-3 hidden">
          <textarea id="promptBox" class="w-full h-48 p-3 rounded bg-slate-900 text-slate-100 border border-slate-700" readonly></textarea>
          <p class="text-xs text-slate-400 mt-1">The prompt summarizes the selected issues and asks for YAML snippets or patch suggestions to fix them in the OpenAPI spec.</p>
        </div>
      </section>

      {{SPECTRAL_SECTION}}
      {{REDOCLY_SECTION}}

      <p class="text-slate-400 text-xs mt-4">Sources: <code class="bg-slate-900 px-1 py-0.5 rounded">dist/grade-report.json</code></p>
    </div>
    <style>
      body.compact tr.sev-warn,
      body.compact tr.sev-warning,
      body.compact tr.sev-info { display: none; }
    </style>
    <!-- AI prompt template will be injected here -->
    {{AI_PROMPT}}

    <script>
      (function(){
        const btn = document.getElementById('compactToggle');
        const apply = (on) => {
          document.body.classList.toggle('compact', !!on);
          btn.classList.toggle('bg-sky-600', !!on);
          const knob = btn.querySelector('span');
          if (knob) knob.style.transform = on ? 'translateX(1.25rem)' : 'translateX(0.25rem)';
          try { localStorage.setItem('gradeReportCompact', on ? '1' : '0'); } catch {}
        };
        let pref = null; try { pref = localStorage.getItem('gradeReportCompact'); } catch {}
        apply(pref === '1');
        btn.addEventListener('click', () => apply(!document.body.classList.contains('compact')));
      })();
      (function(){
        function q(sel){ return document.querySelector(sel); }
        function qa(sel){ return Array.from(document.querySelectorAll(sel)); }
        const genBtn = q('#genPrompt');
        const copyBtn = q('#copyPrompt');
        const copyStatus = q('#copyStatus');
        const boxWrap = q('#promptBoxWrap');
        const box = q('#promptBox');
        const selErrors = q('#selErrors');
        const selWarnings = q('#selWarnings');
        const clearSel = q('#clearSel');
        const incHeur = q('#incHeur');

        selErrors?.addEventListener('click', () => {
          for (const cb of qa('tr.issue-row.sev-error input.sel')) cb.checked = true;
        });
        selWarnings?.addEventListener('click', () => {
          for (const cb of qa('tr.issue-row.sev-warn input.sel, tr.issue-row.sev-warning input.sel')) cb.checked = true;
        });
        clearSel?.addEventListener('click', () => {
          for (const cb of qa('tr.issue-row input.sel')) cb.checked = false;
        });

        function buildPrompt(){
          const rows = qa('tr.issue-row').filter(r => r.querySelector('input.sel')?.checked);
          const items = rows.map(r => ({
            source: r.dataset.source || 'spectral',
            severity: r.dataset.severity || '',
            code: r.dataset.code || '',
            path: r.dataset.path || '',
            where: r.dataset.where || '',
            message: r.dataset.message || ''
          }));
          const itemLines = items.length
            ? items.map((it, i) => `${i+1}. [${it.source}] ${it.severity.toUpperCase()} ${it.code} at ${it.path}${it.where? ' @'+it.where: ''}: ${it.message}`).join('\n')
            : '- No items explicitly selected; suggest general quality improvements.';
          const heurLine = incHeur?.checked
            ? `Heuristics: operations={{operations}}, summaries={{summaryPct}}, descriptions={{descPct}}, has4xx={{with4xxPct}}, opIdUnique={{opIdUniquePct}}, title={{hasTitle}}, version={{hasVersion}}, servers={{hasServers}}, securitySchemes={{hasSecSchemes}}.`
            : '';
          const tpl = document.getElementById('aiPromptTemplate')?.textContent || '';
          return tpl
            .replaceAll('{{HEURISTICS}}', heurLine)
            .replaceAll('{{ITEMS}}', itemLines);
        }

        genBtn?.addEventListener('click', () => {
          const prompt = buildPrompt();
          box.value = prompt;
          boxWrap.classList.remove('hidden');
          copyBtn.disabled = false;
          copyStatus.textContent = '';
        });
        copyBtn?.addEventListener('click', async () => {
          try { await navigator.clipboard.writeText(box.value); copyStatus.textContent = 'Copied!'; }
          catch { copyStatus.textContent = 'Copy failed'; }
          setTimeout(() => copyStatus.textContent = '', 2000);
        });
      })();
    </script>
  </body>
  </html>
