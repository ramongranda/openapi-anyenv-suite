<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenAPI Grade Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
      document.addEventListener('alpine:init', () => {
        try {
          Alpine.store('toast', {
            show: false,
            message: '',
            fire(msg) {
              this.message = String(msg || '');
              this.show = true;
              setTimeout(() => { this.show = false; }, 2000);
            }
          });
        } catch {} // Ignore if Alpine.js is not available
      });
    </script>
  </head>
  <body class="bg-slate-900 text-slate-100">
    <!-- Fullscreen overlay spinner -->
    <div id="rebuildOverlay" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm hidden items-center justify-center z-50">
      <div class="flex flex-col items-center gap-3">
        <div class="h-12 w-12 rounded-full border-4 border-sky-400 border-t-transparent animate-spin"></div>
        <div class="text-slate-200 text-sm">Rebuildingâ€¦</div>
      </div>
    </div>
    <div class="max-w-6xl mx-auto p-6">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <img src="{{logoUrl}}" alt="openapi-anyenv-suite" class="w-10 h-10 rounded-full ring-1 ring-slate-700 {{logoClass}}" />
          <h1 class="text-2xl font-semibold">OpenAPI Grade Report</h1>
        </div>
        <div class="flex items-center gap-4">
          <nav class="hidden sm:flex items-center gap-4 text-sm">
            <a id="docsLink" href="docs.html" class="text-sky-300 hover:underline inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v2.25A2.25 2.25 0 0 1 17.25 18.75h-10.5A2.25 2.25 0 0 1 4.5 16.5V7.125A2.625 2.625 0 0 1 7.125 4.5h5.379c.597 0 1.17.237 1.591.659l2.121 2.121c.422.421.659.994.659 1.591V9.75" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 12.75h7.5m-7.5 3h7.5" />
              </svg>
              <span>Docs</span>
            </a>
            <a id="swaggerLink" href="swagger.html" class="text-sky-300 hover:underline inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 20.25 9.75 17.25 12.75M6.75 6.75 3.75 9.75 6.75 12.75M8.25 19.5l7.5-15" />
              </svg>
              <span>Swagger</span>
            </a>
            <button id="expandAll" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" title="Expand all" aria-label="Expand all">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
              </svg>
            </button>
            <button id="collapseAll" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" title="Collapse all" aria-label="Collapse all">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
              </svg>
            </button>
            <button id="rebuildBtn" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 0 1 12.223-5.59L18 6.75m0-3.75v3.75h-3.75M19.5 12a7.5 7.5 0 0 1-12.223 5.59L6 17.25m0 3.75v-3.75H9.75" />
              </svg>
              <span>Rebuild</span>
            </button>
            <span id="rebuildStatus" class="text-xs text-slate-400"></span>
          </nav>
          <div class="flex items-center gap-3">
            <label for="compactToggle" class="text-sm text-slate-300">Compact (errors only)</label>
            <button id="compactToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-700 transition-colors">
              <span class="inline-block h-4 w-4 translate-x-1 rounded-full bg-white transition-transform"></span>
            </button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-12 gap-4 mt-4">
        <div class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="space-y-2">
            <div>
              <div class="text-xs text-slate-400">Score</div>
              <div class="text-3xl font-bold">{{score}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Grade</div>
              <div><span class="inline-block px-3 py-1 rounded-full {{gradeBg}} {{gradeText}} font-semibold">{{letter}}</span></div>
            </div>
          </div>
        </div>

        <div x-data="{ enabled: (localStorage.getItem('spectral:enabled')!=='0') }" x-init="if(!enabled){ const sec = document.querySelector('#spectral-section'); if(sec){ const c=sec.querySelector('.p-4'); if(c) c.classList.add('hidden'); sec.classList.add('opacity-50'); } } $watch('enabled', v=>{ try{localStorage.setItem('spectral:enabled', v?'1':'0')}catch(e){}; const sec=document.querySelector('#spectral-section'); if(sec){ const c=sec.querySelector('.p-4'); if(c) c.classList.toggle('hidden', !v); sec.classList.toggle('opacity-50', !v); } if(!v){ const was=(localStorage.getItem('redocly:enabled')==='1'); if(!was){ try{localStorage.setItem('redocly:enabled','1')}catch(e){}; const rsec=document.querySelector('#redocly-section'); if(rsec){ const rc=rsec.querySelector('.p-4'); if(rc) rc.classList.remove('hidden'); rsec.classList.remove('opacity-50'); rsec.classList.add('ring-1','ring-sky-500'); setTimeout(()=>{ try{ rsec.classList.remove('ring-1','ring-sky-500'); } catch(e){} }, 900); } const btn=document.getElementById('redoclyEnable'); if(btn && btn.getAttribute('aria-pressed')!=='true'){ try{ btn.click(); } catch(e){} } try{ $store.toast.fire('Redocly enabled to keep at least one linter active'); document.getElementById('rebuildBtn')?.click(); } catch(e){} } } })" class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="relative mb-2">
            <div class="text-xs text-slate-400 text-center">Spectral</div>
            <button id="spectralEnable" type="button" @click="enabled=!enabled" :aria-pressed="enabled" class="absolute right-0 top-1/2 -translate-y-1/2 inline-flex h-6 w-11 items-center rounded-full transition-colors" :class="enabled ? 'bg-sky-600' : 'bg-slate-700'">
              <span class="sr-only">Toggle Spectral</span>
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" :class="enabled ? 'translate-x-6' : 'translate-x-1'"></span>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-slate-400">Errors</div>
              <div class="inline-block px-2 py-1 rounded bg-rose-900/50 text-rose-300 font-semibold">{{spectralErrors}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Warnings</div>
              <div class="inline-block px-2 py-1 rounded bg-amber-900/50 text-amber-300 font-semibold">{{spectralWarnings}}</div>
            </div>
          </div>
        </div>

        <div x-data="{ enabled: (localStorage.getItem('redocly:enabled')==='1') }" x-init="if(!enabled){ const sec = document.querySelector('#redocly-section'); if(sec){ const c=sec.querySelector('.p-4'); if(c) c.classList.add('hidden'); sec.classList.add('opacity-50'); } } $watch('enabled', v=>{ try{localStorage.setItem('redocly:enabled', v?'1':'0')}catch(e){}; const sec=document.querySelector('#redocly-section'); if(sec){ const c=sec.querySelector('.p-4'); if(c) c.classList.toggle('hidden', !v); sec.classList.toggle('opacity-50', !v); } if(!v){ const was=(localStorage.getItem('spectral:enabled')==='1'); if(!was){ try{localStorage.setItem('spectral:enabled','1')}catch(e){}; const ssec=document.querySelector('#spectral-section'); if(ssec){ const sc=ssec.querySelector('.p-4'); if(sc) sc.classList.remove('hidden'); ssec.classList.remove('opacity-50'); ssec.classList.add('ring-1','ring-sky-500'); setTimeout(()=>{ try{ ssec.classList.remove('ring-1','ring-sky-500'); } catch(e){} }, 900); } const btn=document.getElementById('spectralEnable'); if(btn && btn.getAttribute('aria-pressed')!=='true'){ try{ btn.click(); } catch(e){} } try{ $store.toast.fire('Spectral enabled to keep at least one linter active'); } catch(e){} } } })" class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="relative mb-3">
            <div class="text-xs text-slate-400 text-center">Redocly</div>
            <button id="redoclyEnable" type="button" @click="enabled=!enabled" :aria-pressed="enabled" class="absolute right-0 top-1/2 -translate-y-1/2 inline-flex h-6 w-11 items-center rounded-full transition-colors" :class="enabled ? 'bg-sky-600' : 'bg-slate-700'">
              <span class="sr-only">Enable Redocly</span>
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" :class="enabled ? 'translate-x-6' : 'translate-x-1'"></span>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-slate-400">Errors</div>
              <div class="inline-block px-2 py-1 rounded bg-rose-900/50 text-rose-300 font-semibold">{{redoclyErrors}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Warnings</div>
              <div class="inline-block px-2 py-1 rounded bg-amber-900/50 text-amber-300 font-semibold">{{redoclyWarnings}}</div>
            </div>
          </div>
        </div>
      </div>

      <section class="bg-slate-800/80 border border-slate-700 rounded-lg mt-4" x-data="{id:'heuristics', open: (localStorage.getItem('collapse:heuristics')!=='1')}" x-init="$watch('open', v=>{ try{localStorage.setItem('collapse:'+id, v?'0':'1')}catch(e){} })">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700">
          <h2 class="text-sm text-slate-300">Heuristics</h2>
          <button @click="open=!open" :aria-expanded="open" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" aria-label="Toggle section">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4 transition-transform" :class="{'rotate-180': !open}">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
        </div>
        <div class="p-4" x-show="open" x-transition.opacity>
          <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 text-sm">
            <div><div class="text-slate-400 text-xs">Operations</div><div class="font-semibold">{{operations}}</div></div>
          <div><div class="text-slate-400 text-xs">Summaries</div><div class="font-semibold">{{summaryPct}}</div></div>
          <div><div class="text-slate-400 text-xs">Descriptions</div><div class="font-semibold">{{descPct}}</div></div>
          <div><div class="text-slate-400 text-xs">Has 4xx</div><div class="font-semibold">{{with4xxPct}}</div></div>
          <div><div class="text-slate-400 text-xs">OpId Unique</div><div class="font-semibold">{{opIdUniquePct}}</div></div>
          <div><div class="text-slate-400 text-xs">Title</div><div class="font-semibold">{{hasTitle}}</div></div>
          <div><div class="text-slate-400 text-xs">Version</div><div class="font-semibold">{{hasVersion}}</div></div>
          <div><div class="text-slate-400 text-xs">Servers</div><div class="font-semibold">{{hasServers}}</div></div>
          <div><div class="text-slate-400 text-xs">Security Schemes</div><div class="font-semibold">{{hasSecSchemes}}</div></div>
          <div><div class="text-slate-400 text-xs">Bonus</div><div class="font-semibold">{{bonus}}</div></div>
        </div>
        </div>
      </section>

      <section class="bg-slate-800/80 border border-slate-700 rounded-lg mt-4" x-data="{id:'ai-tools', open: (localStorage.getItem('collapse:ai-tools')!=='1')}" x-init="$watch('open', v=>{ try{localStorage.setItem('collapse:'+id, v?'0':'1')}catch(e){} })">
        <div class="flex flex-wrap items-center justify-between gap-3 px-4 py-3 border-b border-slate-700">
          <h2 class="text-sm text-slate-300">AI Tools</h2>
          <button @click="open=!open" :aria-expanded="open" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" aria-label="Toggle section">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4 transition-transform" :class="{'rotate-180': !open}">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
          <div class="flex items-center gap-2">
            <button id="selErrors" class="text-xs px-2 py-1 rounded bg-rose-900/40 border border-rose-700/50 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3.75h.007M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />
              </svg>
              <span>Select errors</span>
            </button>
            <button id="selWarnings" class="text-xs px-2 py-1 rounded bg-amber-900/40 border border-amber-700/50 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3.75h.007M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />
              </svg>
              <span>Select warnings</span>
            </button>
            <button id="selAll" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l2.25 2.25L15.75 10.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />
              </svg>
              <span>Select all</span>
            </button>
            <button id="invertSel" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992M2.985 14.652h4.992M7.977 9.348l-3.99-3.99m3.99 3.99-3.99 3.99m12.036 1.314l3.99 3.99m-3.99-3.99 3.99-3.99" />
              </svg>
              <span>Invert</span>
            </button>
            <button id="clearSel" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
              <span>Clear</span>
            </button>
            <label class="text-xs text-slate-300 ml-2 inline-flex items-center gap-1"><input id="incHeur" type="checkbox" class="align-middle" checked /> Include heuristics</label>
          </div>
        </div>
        <div class="p-4" x-show="open" x-transition.opacity>
        <div class="mt-3 flex flex-wrap items-center gap-2">
          <button id="genPrompt" class="px-3 py-1 rounded bg-sky-700 hover:bg-sky-600 inline-flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.5a.562.562 0 011.04 0l2.062 4.184a.563.563 0 00.424.308l4.622.672a.563.563 0 01.312.961l-3.344 3.26a.563.563 0 00-.162.498l.789 4.6a.563.563 0 01-.816.592L12 17.347l-4.141 2.176a.563.563 0 01-.816-.592l.789-4.6a.563.563 0 00-.162-.499L4.326 9.623a.563.563 0 01.312-.961l4.622-.672a.563.563 0 00.424-.308L11.48 3.5z" />
            </svg>
            <span>Generate AI Prompt</span>
          </button>
          <button id="copyPrompt" class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 inline-flex items-center gap-2" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6.75H5.25A2.25 2.25 0 003 9v9A2.25 2.25 0 005.25 20.25h10.5A2.25 2.25 0 0018 18V9a2.25 2.25 0 00-2.25-2.25z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75V5.25A2.25 2.25 0 019 3h6a2.25 2.25 0 012.25 2.25V6.75" />
            </svg>
            <span>Copy</span>
          </button>
          <span id="copyStatus" class="text-xs text-slate-400"></span>
        </div>
        <div id="promptBoxWrap" class="mt-3 hidden">
          <textarea id="promptBox" class="w-full h-48 p-3 rounded bg-slate-900 text-slate-100 border border-slate-700" readonly></textarea>
          <p class="text-xs text-slate-400 mt-1">The prompt summarizes the selected issues and asks for YAML snippets or patch suggestions to fix them in the OpenAPI spec.</p>
        </div>
        </div>
      </section>

      {{SPECTRAL_SECTION}}
      {{REDOCLY_SECTION}}

      <p class="text-slate-400 text-xs mt-4">Sources: <code class="bg-slate-900 px-1 py-0.5 rounded">dist/grade-report.json</code></p>
    </div>
    <style>
      body.compact tr.sev-warn,
      body.compact tr.sev-warning,
      body.compact tr.sev-info { display: none; }
    </style>
    <!-- AI prompt template will be injected here -->
    {{AI_PROMPT}}

    <script>
      (function(){
        const btn = document.getElementById('compactToggle');
        const apply = (on) => {
          document.body.classList.toggle('compact', !!on);
          btn.classList.toggle('bg-sky-600', !!on);
          const knob = btn.querySelector('span');
          if (knob) knob.style.transform = on ? 'translateX(1.25rem)' : 'translateX(0.25rem)';
          try { localStorage.setItem('gradeReportCompact', on ? '1' : '0'); } catch {} // Ignore if localStorage is not available
        };
        let pref = null; try { pref = localStorage.getItem('gradeReportCompact'); } catch {} // Ignore if localStorage is not available
        apply(pref === '1');
        btn.addEventListener('click', () => apply(!document.body.classList.contains('compact')));
      })();
      (function(){
        function q(sel){ return document.querySelector(sel); }
        function qa(sel){ return Array.from(document.querySelectorAll(sel)); }
        // Collapsible sections with icon
        (function initCollapsibles(){
          const secs = qa('[data-collapsible]');
          for (const sec of secs) {
            const content = sec.querySelector('.collapsible-content');
            const toggle = sec.querySelector('.collapsible-toggle');
            let icon = toggle?.querySelector('.chev');
            if (!content || !toggle) continue;
            // Ensure icon chevron present even if server-rendered button has text
            if (!icon) {
              toggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="chev h-4 w-4 transition-transform" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5H5z"/></svg>';
              icon = toggle.querySelector('.chev');
            }
            // Restore saved state
            const id = sec.getAttribute('data-id') || '';
            try {
              const saved = id ? localStorage.getItem('collapse:'+id) : null;
              if (saved === '1') {
                content.classList.add('hidden');
                toggle.setAttribute('aria-expanded','false');
                if (icon) icon.classList.add('rotate-180');
              }
            } catch {} // Ignore if localStorage is not available
            toggle.addEventListener('click', () => {
              const isHidden = content.classList.toggle('hidden');
              toggle.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
              if (icon) icon.classList.toggle('rotate-180', isHidden);
              const id = sec.getAttribute('data-id') || '';
              try { if (id) localStorage.setItem('collapse:'+id, isHidden ? '1' : '0'); } catch {} // Ignore if localStorage is not available
            });
          }
          // Global expand/collapse
          const expAll = q('#expandAll');
          const colAll = q('#collapseAll');
          function expandAlpineSections() {
            const alpSecs = qa('section[x-data]');
            for (const sec of alpSecs) {
              const content = sec.querySelector('[x-show]');
              const toggle = sec.querySelector('[aria-label="Toggle section"]');
              if (!content || !toggle) continue;
              const isOpen = getComputedStyle(content).display !== 'none';
              if (!isOpen) toggle.click();
            }
          }
          function collapseAlpineSections() {
            const alpSecs = qa('section[x-data]');
            for (const sec of alpSecs) {
              const content = sec.querySelector('[x-show]');
              const toggle = sec.querySelector('[aria-label="Toggle section"]');
              if (!content || !toggle) continue;
              const isOpen = getComputedStyle(content).display !== 'none';
              if (isOpen) toggle.click();
            }
          }
          expAll?.addEventListener('click', () => {
            for (const sec of secs) {
              const content = sec.querySelector('.collapsible-content');
              const icon = sec.querySelector('.chev');
              const toggle = sec.querySelector('.collapsible-toggle');
              if (!content) continue; content.classList.remove('hidden');
              if (icon) icon.classList.remove('rotate-180');
              if (toggle) toggle.setAttribute('aria-expanded','true');
              const id = sec.getAttribute('data-id') || '';
              try { if (id) localStorage.setItem('collapse:'+id, '0'); } catch {} // Ignore if localStorage is not available
            }
            // Also expand Alpine-driven sections (heuristics, AI tools)
            expandAlpineSections();
          });
          colAll?.addEventListener('click', () => {
            for (const sec of secs) {
              const content = sec.querySelector('.collapsible-content');
              const icon = sec.querySelector('.chev');
              const toggle = sec.querySelector('.collapsible-toggle');
              if (!content) continue; content.classList.add('hidden');
              if (icon) icon.classList.add('rotate-180');
              if (toggle) toggle.setAttribute('aria-expanded','false');
              const id = sec.getAttribute('data-id') || '';
              try { if (id) localStorage.setItem('collapse:'+id, '1'); } catch {} // Ignore if localStorage is not available
            }
            // Also collapse Alpine-driven sections (heuristics, AI tools)
            collapseAlpineSections();
          });
        })();
        // Rebuild handler
        const rebuildBtn = q('#rebuildBtn');
        const rebuildStatus = q('#rebuildStatus');
        const overlay = q('#rebuildOverlay');
        const docsLink = q('#docsLink');
        const swaggerLink = q('#swaggerLink');
        function setLinksDisabled(on){
          for (const a of [docsLink, swaggerLink]) {
            if (!a) continue;
            a.classList.toggle('pointer-events-none', !!on);
            a.classList.toggle('opacity-50', !!on);
            a.setAttribute('aria-disabled', on ? 'true' : 'false');
          }
        }
        rebuildBtn?.addEventListener('click', async () => {
          rebuildBtn.disabled = true; rebuildStatus.textContent = 'Rebuildingâ€¦';
          if (overlay) { overlay.classList.remove('hidden'); overlay.classList.add('flex'); }
          setLinksDisabled(true);
          // Disable AI controls and selections during rebuild
          ['#genPrompt','#copyPrompt','#selErrors','#selWarnings','#selAll','#invertSel','#clearSel','#incHeur'].forEach((sel)=>{
            const el = document.querySelector(sel); if (el) { el.disabled = true; el.classList.add('opacity-50','pointer-events-none'); }
          });
          Array.from(document.querySelectorAll('tr.issue-row input.sel')).forEach(cb => cb.disabled = true);
          try {
            let redocly = false; try { redocly = localStorage.getItem('redocly:enabled') === '1'; } catch {} // Ignore if localStorage is not available
            const res = await fetch('/__rebuild', { method: 'POST', cache: 'no-store', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ redocly }) });
            if (!res.ok) throw new Error('HTTP '+res.status);
            rebuildStatus.textContent = 'Done â€“ reloadingâ€¦';
            setTimeout(() => {
              const url = new URL(window.location.href);
              url.searchParams.set('ts', String(Date.now()));
              window.location.replace(url.toString());
            }, 800);
          } catch (e) {
            rebuildStatus.textContent = 'Failed';
            rebuildBtn.disabled = false; setTimeout(() => rebuildStatus.textContent = '', 2000);
            if (overlay) { overlay.classList.add('hidden'); overlay.classList.remove('flex'); }
            setLinksDisabled(false);
            // Re-enable AI controls on failure
            ['#genPrompt','#copyPrompt','#selErrors','#selWarnings','#selAll','#invertSel','#clearSel','#incHeur'].forEach((sel)=>{
              const el = document.querySelector(sel); if (el) { el.disabled = false; el.classList.remove('opacity-50','pointer-events-none'); }
            });
            Array.from(document.querySelectorAll('tr.issue-row input.sel')).forEach(cb => cb.disabled = false);
          }
        });
        const genBtn = q('#genPrompt');
        const copyBtn = q('#copyPrompt');
        const copyStatus = q('#copyStatus');
        const boxWrap = q('#promptBoxWrap');
        const box = q('#promptBox');
        const selErrors = q('#selErrors');
        const selWarnings = q('#selWarnings');
        const selAll = q('#selAll');
        const invertSel = q('#invertSel');
        const clearSel = q('#clearSel');
        const incHeur = q('#incHeur');
        const allCbs = () => qa('tr.issue-row input.sel');

        function updateButtons() {
          const anySelected = allCbs().some(cb => cb.checked);
          genBtn.disabled = !anySelected;
        }

        selErrors?.addEventListener('click', () => {
          for (const cb of qa("tr.issue-row[data-severity='error'] input.sel")) cb.checked = true;
          updateButtons();
        });
        selWarnings?.addEventListener('click', () => {
          for (const cb of qa("tr.issue-row[data-severity^='warn'] input.sel, tr.issue-row[data-severity='warning'] input.sel")) cb.checked = true;
          updateButtons();
        });
        clearSel?.addEventListener('click', () => {
          for (const cb of qa('tr.issue-row input.sel')) cb.checked = false;
          updateButtons();
        });

        selAll?.addEventListener('click', () => {
          for (const cb of qa('tr.issue-row input.sel')) cb.checked = true;
          updateButtons();
        });
        invertSel?.addEventListener('click', () => {
          for (const cb of qa('tr.issue-row input.sel')) cb.checked = !cb.checked;
          updateButtons();
        });

        // Update state when user toggles individual checkboxes
        for (const cb of allCbs()) cb.addEventListener('change', updateButtons);
        // Initial state
        updateButtons();

        function buildPrompt(){
          const rows = qa('tr.issue-row').filter(r => r.querySelector('input.sel')?.checked);
          const items = rows.map(r => ({
            source: r.dataset.source || 'spectral',
            severity: r.dataset.severity || '',
            code: r.dataset.code || '',
            path: r.dataset.path || '',
            where: r.dataset.where || '',
            message: r.dataset.message || ''
          }));
          const itemLines = items.length
            ? items.map((it, i) => `${i+1}. [${it.source}] ${it.severity.toUpperCase()} ${it.code} at ${it.path}${it.where? ' @'+it.where: ''}: ${it.message}`).join('\n')
            : '- No items explicitly selected; suggest general quality improvements.';
          const heurLine = incHeur?.checked
            ? `Heuristics: operations={{operations}}, summaries={{summaryPct}}, descriptions={{descPct}}, has4xx={{with4xxPct}}, opIdUnique={{opIdUniquePct}}, title={{hasTitle}}, version={{hasVersion}}, servers={{hasServers}}, securitySchemes={{hasSecSchemes}}.`
            : '';
          const tpl = document.getElementById('aiPromptTemplate')?.textContent || '';
          return tpl
            .replaceAll('{{HEURISTICS}}', heurLine)
            .replaceAll('{{ITEMS}}', itemLines);
        }

        genBtn?.addEventListener('click', () => {
          const prompt = buildPrompt();
          box.value = prompt;
          boxWrap.classList.remove('hidden');
          copyBtn.disabled = false;
          copyStatus.textContent = '';
        });
        copyBtn?.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(box.value);
            copyStatus.textContent = 'Copied!';
            // Clear prompt after successful copy and hide box
            box.value = '';
            boxWrap.classList.add('hidden');
            copyBtn.disabled = true;
            // Uncheck all selections and update buttons state
            qa('tr.issue-row input.sel').forEach(cb => cb.checked = false);
            updateButtons();
          } catch {
            copyStatus.textContent = 'Copy failed';
          }
          setTimeout(() => (copyStatus.textContent = ''), 2000);
        });
        })();
        // Redocly toggle handled via Alpine in the summary card; no imperative logic needed here.
      </script>
    <footer class="mt-10 text-center text-xs text-slate-500">
      Generated by Zoomiit Â© {{year}}
    </footer>
  </body>
</html>
<!-- Toast notification (Alpine store: $store.toast) -->
<div x-data class="fixed top-4 right-4 z-50" x-show="$store.toast.show" x-transition.opacity>
  <div class="bg-slate-800/90 border border-slate-700 text-slate-100 rounded px-3 py-2 shadow-lg">
    <span x-text="$store.toast.message"></span>
  </div>
</div>