<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenAPI Grade Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body class="bg-slate-900 text-slate-100">
    <!-- Fullscreen overlay spinner -->
    <div id="rebuildOverlay" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm hidden items-center justify-center z-50">
      <div class="flex flex-col items-center gap-3">
        <div class="h-12 w-12 rounded-full border-4 border-sky-400 border-t-transparent animate-spin"></div>
        <div class="text-slate-200 text-sm">Rebuilding…</div>
      </div>
    </div>
    <div class="max-w-6xl mx-auto p-6">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <img src="{{logoUrl}}" alt="openapi-anyenv-suite" class="w-10 h-10 rounded-full ring-1 ring-slate-700 {{logoClass}}" />
          <h1 class="text-2xl font-semibold">OpenAPI Grade Report</h1>
          <p class="text-slate-400 text-sm">Generated by openapi-anyenv-suite</p>
        </div>
        <div class="flex items-center gap-4">
          <nav class="hidden sm:flex items-center gap-4 text-sm">
            <a id="docsLink" href="docs.html" class="text-sky-300 hover:underline">Docs</a>
            <a id="swaggerLink" href="swagger.html" class="text-sky-300 hover:underline">Swagger</a>
            <button id="expandAll" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" title="Expand all" aria-label="Expand all">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5H5z"/></svg>
            </button>
            <button id="collapseAll" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" title="Collapse all" aria-label="Collapse all">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M5 13l5-5 5 5H5z"/></svg>
            </button>
            <button id="rebuildBtn" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600">Rebuild</button>
            <span id="rebuildStatus" class="text-xs text-slate-400"></span>
          </nav>
          <div class="flex items-center gap-3">
            <label for="compactToggle" class="text-sm text-slate-300">Compact (errors only)</label>
            <button id="compactToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-700 transition-colors">
              <span class="inline-block h-4 w-4 translate-x-1 rounded-full bg-white transition-transform"></span>
            </button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-12 gap-4 mt-4">
        <div class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="space-y-2">
            <div>
              <div class="text-xs text-slate-400">Numeric Score</div>
              <div class="text-3xl font-bold">{{score}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Letter</div>
              <div><span class="inline-block px-3 py-1 rounded-full bg-sky-900/60 text-sky-300 font-semibold">{{letter}}</span></div>
            </div>
          </div>
        </div>

        <div class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-slate-400">Spectral Errors</div>
              <div class="inline-block px-2 py-1 rounded bg-rose-900/50 text-rose-300 font-semibold">{{spectralErrors}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Spectral Warnings</div>
              <div class="inline-block px-2 py-1 rounded bg-amber-900/50 text-amber-300 font-semibold">{{spectralWarnings}}</div>
            </div>
          </div>
        </div>

        <div class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-slate-400">Redocly Errors</div>
              <div class="inline-block px-2 py-1 rounded bg-rose-900/50 text-rose-300 font-semibold">{{redoclyErrors}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Redocly Warnings</div>
              <div class="inline-block px-2 py-1 rounded bg-amber-900/50 text-amber-300 font-semibold">{{redoclyWarnings}}</div>
            </div>
          </div>
        </div>
      </div>

      <section class="bg-slate-800/80 border border-slate-700 rounded-lg mt-4" x-data="{id:'heuristics', open: (localStorage.getItem('collapse:heuristics')!=='1')}" x-init="$watch('open', v=>{ try{localStorage.setItem('collapse:'+id, v?'0':'1')}catch(e){} })">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700">
          <h2 class="text-sm text-slate-300">Heuristics</h2>
          <button @click="open=!open" :aria-expanded="open" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" aria-label="Toggle section">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform" :class="{'rotate-180': !open}" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5H5z"/></svg>
          </button>
        </div>
        <div class="p-4" x-show="open" x-transition.opacity>
          <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 text-sm">
            <div><div class="text-slate-400 text-xs">Operations</div><div class="font-semibold">{{operations}}</div></div>
          <div><div class="text-slate-400 text-xs">Summaries</div><div class="font-semibold">{{summaryPct}}</div></div>
          <div><div class="text-slate-400 text-xs">Descriptions</div><div class="font-semibold">{{descPct}}</div></div>
          <div><div class="text-slate-400 text-xs">Has 4xx</div><div class="font-semibold">{{with4xxPct}}</div></div>
          <div><div class="text-slate-400 text-xs">OpId Unique</div><div class="font-semibold">{{opIdUniquePct}}</div></div>
          <div><div class="text-slate-400 text-xs">Title</div><div class="font-semibold">{{hasTitle}}</div></div>
          <div><div class="text-slate-400 text-xs">Version</div><div class="font-semibold">{{hasVersion}}</div></div>
          <div><div class="text-slate-400 text-xs">Servers</div><div class="font-semibold">{{hasServers}}</div></div>
          <div><div class="text-slate-400 text-xs">Security Schemes</div><div class="font-semibold">{{hasSecSchemes}}</div></div>
          <div><div class="text-slate-400 text-xs">Bonus</div><div class="font-semibold">{{bonus}}</div></div>
        </div>
        </div>
      </section>

      <section class="bg-slate-800/80 border border-slate-700 rounded-lg mt-4" x-data="{id:'ai-tools', open: (localStorage.getItem('collapse:ai-tools')!=='1')}" x-init="$watch('open', v=>{ try{localStorage.setItem('collapse:'+id, v?'0':'1')}catch(e){} })">
        <div class="flex flex-wrap items-center justify-between gap-3 px-4 py-3 border-b border-slate-700">
          <h2 class="text-sm text-slate-300">AI Tools</h2>
          <button @click="open=!open" :aria-expanded="open" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" aria-label="Toggle section">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform" :class="{'rotate-180': !open}" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5H5z"/></svg>
          </button>
          <div class="flex items-center gap-2">
            <button id="selErrors" class="text-xs px-2 py-1 rounded bg-rose-900/40 border border-rose-700/50">Select errors</button>
            <button id="selWarnings" class="text-xs px-2 py-1 rounded bg-amber-900/40 border border-amber-700/50">Select warnings</button>
            <button id="selAll" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600">Select all</button>
            <button id="invertSel" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600">Invert</button>
            <button id="clearSel" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600">Clear</button>
            <label class="text-xs text-slate-300 ml-2 inline-flex items-center gap-1"><input id="incHeur" type="checkbox" class="align-middle" checked /> Include heuristics</label>
          </div>
        </div>
        <div class="p-4" x-show="open" x-transition.opacity>
        <div class="mt-3 flex flex-wrap items-center gap-2">
          <button id="genPrompt" class="px-3 py-1 rounded bg-sky-700 hover:bg-sky-600">Generate AI Prompt</button>
          <button id="copyPrompt" class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600" disabled>Copy</button>
          <span id="copyStatus" class="text-xs text-slate-400"></span>
        </div>
        <div id="promptBoxWrap" class="mt-3 hidden">
          <textarea id="promptBox" class="w-full h-48 p-3 rounded bg-slate-900 text-slate-100 border border-slate-700" readonly></textarea>
          <p class="text-xs text-slate-400 mt-1">The prompt summarizes the selected issues and asks for YAML snippets or patch suggestions to fix them in the OpenAPI spec.</p>
        </div>
        </div>
      </section>

      {{SPECTRAL_SECTION}}
      {{REDOCLY_SECTION}}

      <p class="text-slate-400 text-xs mt-4">Sources: <code class="bg-slate-900 px-1 py-0.5 rounded">dist/grade-report.json</code></p>
    </div>
    <style>
      body.compact tr.sev-warn,
      body.compact tr.sev-warning,
      body.compact tr.sev-info { display: none; }
    </style>
    <!-- AI prompt template will be injected here -->
    {{AI_PROMPT}}

    <script>
      (function(){
        const btn = document.getElementById('compactToggle');
        const apply = (on) => {
          document.body.classList.toggle('compact', !!on);
          btn.classList.toggle('bg-sky-600', !!on);
          const knob = btn.querySelector('span');
          if (knob) knob.style.transform = on ? 'translateX(1.25rem)' : 'translateX(0.25rem)';
          try { localStorage.setItem('gradeReportCompact', on ? '1' : '0'); } catch {}
        };
        let pref = null; try { pref = localStorage.getItem('gradeReportCompact'); } catch {}
        apply(pref === '1');
        btn.addEventListener('click', () => apply(!document.body.classList.contains('compact')));
      })();
      (function(){
        function q(sel){ return document.querySelector(sel); }
        function qa(sel){ return Array.from(document.querySelectorAll(sel)); }
        // Collapsible sections with icon
        (function initCollapsibles(){
          const secs = qa('[data-collapsible]');
          for (const sec of secs) {
            const content = sec.querySelector('.collapsible-content');
            const toggle = sec.querySelector('.collapsible-toggle');
            let icon = toggle?.querySelector('.chev');
            if (!content || !toggle) continue;
            // Ensure icon chevron present even if server-rendered button has text
            if (!icon) {
              toggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="chev h-4 w-4 transition-transform" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5H5z"/></svg>';
              icon = toggle.querySelector('.chev');
            }
            // Restore saved state
            const id = sec.getAttribute('data-id') || '';
            try {
              const saved = id ? localStorage.getItem('collapse:'+id) : null;
              if (saved === '1') {
                content.classList.add('hidden');
                toggle.setAttribute('aria-expanded','false');
                if (icon) icon.classList.add('rotate-180');
              }
            } catch {}
            toggle.addEventListener('click', () => {
              const isHidden = content.classList.toggle('hidden');
              toggle.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
              if (icon) icon.classList.toggle('rotate-180', isHidden);
              const id = sec.getAttribute('data-id') || '';
              try { if (id) localStorage.setItem('collapse:'+id, isHidden ? '1' : '0'); } catch {}
            });
          }
          // Global expand/collapse
          const expAll = q('#expandAll');
          const colAll = q('#collapseAll');
          expAll?.addEventListener('click', () => {
            for (const sec of secs) {
              const content = sec.querySelector('.collapsible-content');
              const icon = sec.querySelector('.chev');
              const toggle = sec.querySelector('.collapsible-toggle');
              if (!content) continue; content.classList.remove('hidden');
              if (icon) icon.classList.remove('rotate-180');
              if (toggle) toggle.setAttribute('aria-expanded','true');
              const id = sec.getAttribute('data-id') || '';
              try { if (id) localStorage.setItem('collapse:'+id, '0'); } catch {}
            }
          });
          colAll?.addEventListener('click', () => {
            for (const sec of secs) {
              const content = sec.querySelector('.collapsible-content');
              const icon = sec.querySelector('.chev');
              const toggle = sec.querySelector('.collapsible-toggle');
              if (!content) continue; content.classList.add('hidden');
              if (icon) icon.classList.add('rotate-180');
              if (toggle) toggle.setAttribute('aria-expanded','false');
              const id = sec.getAttribute('data-id') || '';
              try { if (id) localStorage.setItem('collapse:'+id, '1'); } catch {}
            }
          });
        })();
        // Rebuild handler
        const rebuildBtn = q('#rebuildBtn');
        const rebuildStatus = q('#rebuildStatus');
        const overlay = q('#rebuildOverlay');
        const docsLink = q('#docsLink');
        const swaggerLink = q('#swaggerLink');
        function setLinksDisabled(on){
          for (const a of [docsLink, swaggerLink]) {
            if (!a) continue;
            a.classList.toggle('pointer-events-none', !!on);
            a.classList.toggle('opacity-50', !!on);
            a.setAttribute('aria-disabled', on ? 'true' : 'false');
          }
        }
        rebuildBtn?.addEventListener('click', async () => {
          rebuildBtn.disabled = true; rebuildStatus.textContent = 'Rebuilding…';
          if (overlay) { overlay.classList.remove('hidden'); overlay.classList.add('flex'); }
          setLinksDisabled(true);
          // Disable AI controls and selections during rebuild
          ['#genPrompt','#copyPrompt','#selErrors','#selWarnings','#selAll','#invertSel','#clearSel','#incHeur'].forEach((sel)=>{
            const el = document.querySelector(sel); if (el) { el.disabled = true; el.classList.add('opacity-50','pointer-events-none'); }
          });
          Array.from(document.querySelectorAll('tr.issue-row input.sel')).forEach(cb => cb.disabled = true);
          try {
            const res = await fetch('/__rebuild', { method: 'POST', cache: 'no-store' });
            if (!res.ok) throw new Error('HTTP '+res.status);
            rebuildStatus.textContent = 'Done – reloading…';
            setTimeout(() => {
              const url = new URL(window.location.href);
              url.searchParams.set('ts', String(Date.now()));
              window.location.replace(url.toString());
            }, 800);
          } catch (e) {
            rebuildStatus.textContent = 'Failed';
            rebuildBtn.disabled = false; setTimeout(() => rebuildStatus.textContent = '', 2000);
            if (overlay) { overlay.classList.add('hidden'); overlay.classList.remove('flex'); }
            setLinksDisabled(false);
            // Re-enable AI controls on failure
            ['#genPrompt','#copyPrompt','#selErrors','#selWarnings','#selAll','#invertSel','#clearSel','#incHeur'].forEach((sel)=>{
              const el = document.querySelector(sel); if (el) { el.disabled = false; el.classList.remove('opacity-50','pointer-events-none'); }
            });
            Array.from(document.querySelectorAll('tr.issue-row input.sel')).forEach(cb => cb.disabled = false);
          }
        });
        const genBtn = q('#genPrompt');
        const copyBtn = q('#copyPrompt');
        const copyStatus = q('#copyStatus');
        const boxWrap = q('#promptBoxWrap');
        const box = q('#promptBox');
        const selErrors = q('#selErrors');
        const selWarnings = q('#selWarnings');
        const selAll = q('#selAll');
        const invertSel = q('#invertSel');
        const clearSel = q('#clearSel');
        const incHeur = q('#incHeur');
        const allCbs = () => qa('tr.issue-row input.sel');

        function updateButtons() {
          const anySelected = allCbs().some(cb => cb.checked);
          genBtn.disabled = !anySelected;
        }

        selErrors?.addEventListener('click', () => {
          for (const cb of qa("tr.issue-row[data-severity='error'] input.sel")) cb.checked = true;
          updateButtons();
        });
        selWarnings?.addEventListener('click', () => {
          for (const cb of qa("tr.issue-row[data-severity^='warn'] input.sel, tr.issue-row[data-severity='warning'] input.sel")) cb.checked = true;
          updateButtons();
        });
        clearSel?.addEventListener('click', () => {
          for (const cb of qa('tr.issue-row input.sel')) cb.checked = false;
          updateButtons();
        });

        selAll?.addEventListener('click', () => {
          for (const cb of qa('tr.issue-row input.sel')) cb.checked = true;
          updateButtons();
        });
        invertSel?.addEventListener('click', () => {
          for (const cb of qa('tr.issue-row input.sel')) cb.checked = !cb.checked;
          updateButtons();
        });

        // Update state when user toggles individual checkboxes
        for (const cb of allCbs()) cb.addEventListener('change', updateButtons);
        // Initial state
        updateButtons();

        function buildPrompt(){
          const rows = qa('tr.issue-row').filter(r => r.querySelector('input.sel')?.checked);
          const items = rows.map(r => ({
            source: r.dataset.source || 'spectral',
            severity: r.dataset.severity || '',
            code: r.dataset.code || '',
            path: r.dataset.path || '',
            where: r.dataset.where || '',
            message: r.dataset.message || ''
          }));
          const itemLines = items.length
            ? items.map((it, i) => `${i+1}. [${it.source}] ${it.severity.toUpperCase()} ${it.code} at ${it.path}${it.where? ' @'+it.where: ''}: ${it.message}`).join('\n')
            : '- No items explicitly selected; suggest general quality improvements.';
          const heurLine = incHeur?.checked
            ? `Heuristics: operations={{operations}}, summaries={{summaryPct}}, descriptions={{descPct}}, has4xx={{with4xxPct}}, opIdUnique={{opIdUniquePct}}, title={{hasTitle}}, version={{hasVersion}}, servers={{hasServers}}, securitySchemes={{hasSecSchemes}}.`
            : '';
          const tpl = document.getElementById('aiPromptTemplate')?.textContent || '';
          return tpl
            .replaceAll('{{HEURISTICS}}', heurLine)
            .replaceAll('{{ITEMS}}', itemLines);
        }

        genBtn?.addEventListener('click', () => {
          const prompt = buildPrompt();
          box.value = prompt;
          boxWrap.classList.remove('hidden');
          copyBtn.disabled = false;
          copyStatus.textContent = '';
        });
        copyBtn?.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(box.value);
            copyStatus.textContent = 'Copied!';
            // Clear prompt after successful copy and hide box
            box.value = '';
            boxWrap.classList.add('hidden');
            copyBtn.disabled = true;
            // Uncheck all selections and update buttons state
            qa('tr.issue-row input.sel').forEach(cb => cb.checked = false);
            updateButtons();
          } catch {
            copyStatus.textContent = 'Copy failed';
          }
          setTimeout(() => (copyStatus.textContent = ''), 2000);
        });
      })();
    </script>
  </body>
  </html>
