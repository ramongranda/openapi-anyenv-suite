<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenAPI Grade Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
      document.addEventListener('alpine:init', () => {
        try {
          Alpine.store('toast', {
            show: false,
            message: '',
            fire(msg) {
              this.message = String(msg || '');
              this.show = true;
              setTimeout(() => { this.show = false; }, 2000);
            }
          });
        } catch {} // Ignore if Alpine.js is not available
      });
    </script>
  </head>
  <body class="bg-slate-900 text-slate-100">
      </div>
    </div>
    <div class="max-w-6xl mx-auto p-6">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <img src="{{logoUrl}}" alt="openapi-anyenv-suite" class="w-10 h-10 rounded-full ring-1 ring-slate-700 {{logoClass}}" />
          <h1 class="text-2xl font-semibold">OpenAPI Grade Report</h1>
        </div>
        <div class="flex items-center gap-4">
          <nav class="hidden sm:flex items-center gap-4 text-sm">
            <a id="docsLink" href="docs.html" class="text-sky-300 hover:underline inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v2.25A2.25 2.25 0 0 1 17.25 18.75h-10.5A2.25 2.25 0 0 1 4.5 16.5V7.125A2.625 2.625 0 0 1 7.125 4.5h5.379c.597 0 1.17.237 1.591.659l2.121 2.121c.422.421.659.994.659 1.591V9.75" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 12.75h7.5m-7.5 3h7.5" />
              </svg>
              <span>Docs</span>
            </a>
            <span id="docsToolBadge">{{docsBadge}}</span>
            <a id="swaggerLink" href="swagger.html" class="text-sky-300 hover:underline inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 20.25 9.75 17.25 12.75M6.75 6.75 3.75 9.75 6.75 12.75M8.25 19.5l7.5-15" />
              </svg>
              <span>Swagger</span>
            </a>
          </nav>
          
        </div>
      </div>

      <div class="grid grid-cols-12 gap-4 mt-4">
        <div class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="space-y-2">
            <div>
              <div class="text-xs text-slate-400">Score</div>
              <div class="text-3xl font-bold">{{score}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Grade</div>
              <div><span class="inline-block px-3 py-1 rounded-full {{gradeBg}} {{gradeText}} font-semibold">{{letter}}</span></div>
            </div>
          </div>
        </div>

        <div x-data="{ enabled: (localStorage.getItem('spectral:enabled')!=='0') }" x-init="if(!enabled){ const sec = document.querySelector('#spectral-section'); if(sec){ const c=sec.querySelector('.p-4'); if(c) c.classList.add('hidden'); sec.classList.add('opacity-50'); } } $watch('enabled', v=>{ try{localStorage.setItem('spectral:enabled', v?'1':'0')}catch(e){}; const sec=document.querySelector('#spectral-section'); if(sec){ const c=sec.querySelector('.p-4'); if(c) c.classList.toggle('hidden', !v); sec.classList.toggle('opacity-50', !v); } if(!v){ const was=(localStorage.getItem('redocly:enabled')==='1'); if(!was){ try{localStorage.setItem('redocly:enabled','1')}catch(e){}; const rsec=document.querySelector('#redocly-section'); if(rsec){ const rc=rsec.querySelector('.p-4'); if(rc) rc.classList.remove('hidden'); rsec.classList.remove('opacity-50'); rsec.classList.add('ring-1','ring-sky-500'); setTimeout(()=>{ try{ rsec.classList.remove('ring-1','ring-sky-500'); } catch(e){} }, 900); } const btn=document.getElementById('redoclyEnable'); if(btn && btn.getAttribute('aria-pressed')!=='true'){ try{ btn.click(); } catch(e){} } try{ $store.toast.fire('Redocly enabled to keep at least one linter active');  } catch(e){} } } })" class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="relative mb-2">
            <div class="text-xs text-slate-400 text-center">Spectral</div>
            <button id="spectralEnable" type="button" @click="enabled=!enabled" :aria-pressed="enabled" class="absolute right-0 top-1/2 -translate-y-1/2 inline-flex h-6 w-11 items-center rounded-full transition-colors" :class="enabled ? 'bg-sky-600' : 'bg-slate-700'">
              <span class="sr-only">Toggle Spectral</span>
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" :class="enabled ? 'translate-x-6' : 'translate-x-1'"></span>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-slate-400">Errors</div>
              <div class="inline-block px-2 py-1 rounded bg-rose-900/50 text-rose-300 font-semibold">{{spectralErrors}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Warnings</div>
              <div class="inline-block px-2 py-1 rounded bg-amber-900/50 text-amber-300 font-semibold">{{spectralWarnings}}</div>
            </div>
          </div>
        </div>

  <div x-data="{ enabled: (localStorage.getItem('redocly:enabled')==='1') && {{redoclyAvailable}} }" x-init="if(!enabled){ const sec = document.querySelector('#redocly-section'); if(sec){ const c=sec.querySelector('.p-4'); if(c) c.classList.add('hidden'); sec.classList.add('opacity-50'); } } $watch('enabled', v=>{ try{localStorage.setItem('redocly:enabled', v?'1':'0')}catch(e){}; const sec=document.querySelector('#redocly-section'); if(sec){ const c=sec.querySelector('.p-4'); if(c) c.classList.toggle('hidden', !v); sec.classList.toggle('opacity-50', !v); } if(!v){ const was=(localStorage.getItem('spectral:enabled')==='1'); if(!was){ try{localStorage.setItem('spectral:enabled','1')}catch(e){}; const ssec=document.querySelector('#spectral-section'); if(ssec){ const sc=ssec.querySelector('.p-4'); if(sc) sc.classList.remove('hidden'); ssec.classList.remove('opacity-50'); ssec.classList.add('ring-1','ring-sky-500'); setTimeout(()=>{ try{ ssec.classList.remove('ring-1','ring-sky-500'); } catch(e){} }, 900); } const btn=document.getElementById('spectralEnable'); if(btn && btn.getAttribute('aria-pressed')!=='true'){ try{ btn.click(); } catch(e){} } try{ $store.toast.fire('Spectral enabled to keep at least one linter active'); } catch(e){} } } })" class="col-span-12 sm:col-span-4 bg-slate-800/80 border border-slate-700 rounded-lg p-4">
          <div class="relative mb-3">
            <div class="text-xs text-slate-400 text-center">Redocly</div>
            <button id="redoclyEnable" type="button" @click="enabled=!enabled" aria-pressed="{{redoclyAriaPressed}}" class="absolute right-0 top-1/2 -translate-y-1/2 inline-flex h-6 w-11 items-center rounded-full transition-colors {{redoclyBtnClass}} {{redoclyDisabledClasses}}" {{redoclyDisabledAttr}}>
              <span class="sr-only">Enable Redocly</span>
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform {{redoclyKnobClass}}"></span>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-slate-400">Errors</div>
              <div class="inline-block px-2 py-1 rounded bg-rose-900/50 text-rose-300 font-semibold">{{redoclyErrors}}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400">Warnings</div>
              <div class="inline-block px-2 py-1 rounded bg-amber-900/50 text-amber-300 font-semibold">{{redoclyWarnings}}</div>
            </div>
          </div>
        </div>
      </div>

      <section class="bg-slate-800/80 border border-slate-700 rounded-lg mt-4" x-data="{id:'heuristics', open: (localStorage.getItem('collapse:heuristics')!=='1')}" x-init="$watch('open', v=>{ try{localStorage.setItem('collapse:'+id, v?'0':'1')}catch(e){} })">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700">
          <h2 class="text-sm text-slate-300">Heuristics</h2>
          <button @click="open=!open" :aria-expanded="open" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" aria-label="Toggle section">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4 transition-transform" :class="{'rotate-180': !open}">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
        </div>
        <div class="p-4" x-show="open" x-transition.opacity>
          <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 text-sm">
            <div><div class="text-slate-400 text-xs">Operations</div><div class="font-semibold" data-heur="operations">{{operations}}</div></div>
          <div><div class="text-slate-400 text-xs">Summaries</div><div class="font-semibold" data-heur="summaryPct">{{summaryPct}}</div></div>
          <div><div class="text-slate-400 text-xs">Descriptions</div><div class="font-semibold" data-heur="descPct">{{descPct}}</div></div>
          <div><div class="text-slate-400 text-xs">Has 4xx</div><div class="font-semibold" data-heur="with4xxPct">{{with4xxPct}}</div></div>
          <div><div class="text-slate-400 text-xs">OpId Unique</div><div class="font-semibold" data-heur="opIdUniquePct">{{opIdUniquePct}}</div></div>
          <div><div class="text-slate-400 text-xs">Title</div><div class="font-semibold" data-heur="hasTitle">{{hasTitle}}</div></div>
          <div><div class="text-slate-400 text-xs">Version</div><div class="font-semibold" data-heur="hasVersion">{{hasVersion}}</div></div>
          <div><div class="text-slate-400 text-xs">Servers</div><div class="font-semibold" data-heur="hasServers">{{hasServers}}</div></div>
          <div><div class="text-slate-400 text-xs">Security Schemes</div><div class="font-semibold" data-heur="hasSecSchemes">{{hasSecSchemes}}</div></div>
          <div><div class="text-slate-400 text-xs">Bonus</div><div class="font-semibold" data-heur="bonus">{{bonus}}</div></div>
        </div>
        </div>
      </section>

      <section class="bg-slate-800/80 border border-slate-700 rounded-lg mt-4" x-data="{id:'ai-tools', open: (localStorage.getItem('collapse:ai-tools')!=='1')}" x-init="$watch('open', v=>{ try{localStorage.setItem('collapse:'+id, v?'0':'1')}catch(e){} })">
        <div class="flex flex-wrap items-center justify-between gap-3 px-4 py-3 border-b border-slate-700">
          <h2 class="text-sm text-slate-300">AI Tools</h2>
          <button @click="open=!open" :aria-expanded="open" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600" aria-label="Toggle section">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4 transition-transform" :class="{'rotate-180': !open}">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
          <div class="flex items-center gap-2">
            <button id="selErrors" class="text-xs px-2 py-1 rounded bg-rose-900/40 border border-rose-700/50 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3.75h.007M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />
              </svg>
              <span>Select errors</span>
            </button>
            <button id="selWarnings" class="text-xs px-2 py-1 rounded bg-amber-900/40 border border-amber-700/50 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3.75h.007M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />
              </svg>
              <span>Select warnings</span>
            </button>
            <button id="selAll" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l2.25 2.25L15.75 10.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />
              </svg>
              <span>Select all</span>
            </button>
            <button id="invertSel" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992M2.985 14.652h4.992M7.977 9.348l-3.99-3.99m3.99 3.99-3.99 3.99m12.036 1.314l3.99 3.99m-3.99-3.99 3.99-3.99" />
              </svg>
              <span>Invert</span>
            </button>
            <button id="clearSel" class="text-xs px-2 py-1 rounded bg-slate-700/60 border border-slate-600 inline-flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
              <span>Clear</span>
            </button>
            <label class="text-xs text-slate-300 ml-2 inline-flex items-center gap-1"><input id="incHeur" type="checkbox" class="align-middle" checked /> Include heuristics</label>
          </div>
        </div>
        <div class="p-4" x-show="open" x-transition.opacity>
        <div class="mt-3 flex flex-wrap items-center gap-2">
          <button id="genPrompt" class="px-3 py-1 rounded bg-sky-700 hover:bg-sky-600 inline-flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.5a.562.562 0 011.04 0l2.062 4.184a.563.563 0 00.424.308l4.622.672a.563.563 0 01.312.961l-3.344 3.26a.563.563 0 00-.162.498l.789 4.6a.563.563 0 01-.816.592L12 17.347l-4.141 2.176a.563.563 0 01-.816-.592l.789-4.6a.563.563 0 00-.162-.499L4.326 9.623a.563.563 0 01.312-.961l4.622-.672a.563.563 0 00.424-.308L11.48 3.5z" />
            </svg>
            <span>Generate AI Prompt</span>
          </button>
          <button id="copyPrompt" class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 inline-flex items-center gap-2" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6.75H5.25A2.25 2.25 0 003 9v9A2.25 2.25 0 005.25 20.25h10.5A2.25 2.25 0 0018 18V9a2.25 2.25 0 00-2.25-2.25z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75V5.25A2.25 2.25 0 019 3h6a2.25 2.25 0 012.25 2.25V6.75" />
            </svg>
            <span>Copy</span>
          </button>
          <span id="copyStatus" class="text-xs text-slate-400"></span>
        </div>
        <div id="promptBoxWrap" class="mt-3 hidden">
          <textarea id="promptBox" aria-label="AI prompt" title="AI prompt" placeholder="Generated AI prompt (read-only)" class="w-full h-48 p-3 rounded bg-slate-900 text-slate-100 border border-slate-700" readonly></textarea>
          <p class="text-xs text-slate-400 mt-1">The prompt summarizes the selected problems and asks for YAML snippets or patch suggestions to fix them in the OpenAPI spec.</p>
        </div>
        </div>
      </section>

      <!-- Problem tables: show separate stacked sections for each linter. If a section is empty, it will be removed by client JS. -->
      <div id="problemsContainer" class="mt-4 space-y-4">
        <div id="spectralContent" data-tabpanel="spectral">{{SPECTRAL_SECTION}}</div>
        <div id="redoclyContent" data-tabpanel="redocly">{{REDOCLY_SECTION}}</div>
      </div>

      <p class="text-slate-400 text-xs mt-4">Sources: <code class="bg-slate-900 px-1 py-0.5 rounded">dist/grade-report.json</code></p>
    </div>
    <style>
    /* per-panel expanded state: when a panel is expanded, lift the max-height
      constraint applied to the inner scroller so the container grows to fit
      the table (this expands the container, not the table content). */
    .panel-expanded .max-h-\[420px\] { max-height: none !important; }
    .panel-expanded .overflow-auto { overflow: visible !important; }
    /* Remove vertical scroll for issue tables; pagination handles item visibility */
    .overflow-auto { overflow-x: auto; overflow-y: visible; }
    </style>
    <!-- AI prompt template will be injected here -->
    {{AI_PROMPT}}

    <script>
      // Runtime: update docs badge from dist/grade-report.json if available
      (function(){
        async function refreshDocsBadge(){
          try{
            const res = await fetch('/grade-report.json', { cache: 'no-store' });
            if (!res.ok) return;
            const j = await res.json();
            const span = document.getElementById('docsToolBadge');
            if (!span) return;
            const docs = j?.docs || { generated: false, tool: null };
            let html = '';
            if (docs.generated) {
              if (docs.tool === 'redocly') html = '<span class="ml-2 inline-block text-xs px-2 py-0.5 rounded bg-sky-600 text-white">Redocly</span>';
              else if (docs.tool === 'redoc-cli') html = '<span class="ml-2 inline-block text-xs px-2 py-0.5 rounded bg-indigo-600 text-white">redoc-cli</span>';
              else html = '<span class="ml-2 inline-block text-xs px-2 py-0.5 rounded bg-amber-600 text-black">Fallback</span>';
            } else {
              html = '<span class="ml-2 inline-block text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300">No docs</span>';
            }
            span.innerHTML = html;
          }catch(e){}
        }
        // refresh on load
        try { refreshDocsBadge(); } catch(e){}
      })();
      
  (function(){
  function q(sel){ return document.querySelector(sel); }
  function qa(sel){ return Array.from(document.querySelectorAll(sel)); }
  // Problems container (both Spectral and Redocly panels live here)
  const problemsContainer = q('#problemsContainer');
        // Collapsible sections with icon
        (function initCollapsibles(){
          const secs = qa('[data-collapsible]');
          for (const sec of secs) {
            const content = sec.querySelector('.collapsible-content');
            const toggle = sec.querySelector('.collapsible-toggle');
            let icon = toggle?.querySelector('.chev');
            if (!content || !toggle) continue;
            // Ensure icon chevron present even if server-rendered button has text
            if (!icon) {
              toggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="chev h-4 w-4 transition-transform" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5H5z"/></svg>';
              icon = toggle.querySelector('.chev');
            }
            // Restore saved state
            const id = sec.getAttribute('data-id') || '';
            try {
              const saved = id ? localStorage.getItem('collapse:'+id) : null;
              if (saved === '1') {
                content.classList.add('hidden');
                toggle.setAttribute('aria-expanded','false');
                if (icon) icon.classList.add('rotate-180');
              }
            } catch {} // Ignore if localStorage is not available
            toggle.addEventListener('click', () => {
              const isHidden = content.classList.toggle('hidden');
              toggle.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
              if (icon) icon.classList.toggle('rotate-180', isHidden);
              const id = sec.getAttribute('data-id') || '';
              try { if (id) localStorage.setItem('collapse:'+id, isHidden ? '1' : '0'); } catch {} // Ignore if localStorage is not available
            });
          }
          // Global expand/collapse
          const allToggle = q('#toggleAll');
          function anyPanelCollapsed() {
            // If any panel content (the .p-4 wrapper) is hidden, consider collapsed
            const panels = qa('[data-tabpanel]');
            for (const p of panels) {
              const content = p.querySelector('.p-4');
              if (content && getComputedStyle(content).display === 'none') return true;
            }
            // Also check Alpine sections (heuristics/AI) for collapsed state
            const alpSecs = qa('section[x-data]');
            for (const s of alpSecs) {
              const content = s.querySelector('[x-show]');
              if (content && getComputedStyle(content).display === 'none') return true;
            }
            return false;
          }

          function expandEverything() {
            for (const sec of secs) {
              const content = sec.querySelector('.collapsible-content');
              const icon = sec.querySelector('.chev');
              const toggle = sec.querySelector('.collapsible-toggle');
              if (!content) continue; content.classList.remove('hidden');
              if (icon) icon.classList.remove('rotate-180');
              if (toggle) toggle.setAttribute('aria-expanded','true');
              const id = sec.getAttribute('data-id') || '';
              try { if (id) localStorage.setItem('collapse:'+id, '0'); } catch {}
            }
            expandAlpineSections();
            try {
              const panels = qa('[data-tabpanel]');
              for (const p of panels) {
                const btn = p.querySelector('.panel-expander');
                const content = p.querySelector('.p-4');
                if (content) content.classList.remove('hidden');
                if (btn) {
                  btn.setAttribute('aria-expanded','true');
                  const che = btn.querySelector('.chev'); if (che) che.classList.remove('rotate-180');
                }
                const id = `panel:${p.getAttribute('data-tabpanel')}`;
                try { if (id) localStorage.setItem('collapse:'+id, '0'); } catch(e) {}
              }
            } catch(e) {}
            try { const svg = allToggle?.querySelector('.chev'); if (svg) svg.classList.remove('rotate-180'); } catch(e) {}
          }

          function collapseEverything() {
            for (const sec of secs) {
              const content = sec.querySelector('.collapsible-content');
              const icon = sec.querySelector('.chev');
              const toggle = sec.querySelector('.collapsible-toggle');
              if (!content) continue; content.classList.add('hidden');
              if (icon) icon.classList.add('rotate-180');
              if (toggle) toggle.setAttribute('aria-expanded','false');
              const id = sec.getAttribute('data-id') || '';
              try { if (id) localStorage.setItem('collapse:'+id, '1'); } catch {}
            }
            collapseAlpineSections();
            try {
              const panels = qa('[data-tabpanel]');
              for (const p of panels) {
                const btn = p.querySelector('.panel-expander');
                const content = p.querySelector('.p-4');
                if (content) content.classList.add('hidden');
                if (btn) {
                  btn.setAttribute('aria-expanded','false');
                  const che = btn.querySelector('.chev'); if (che) che.classList.add('rotate-180');
                }
                const id = `panel:${p.getAttribute('data-tabpanel')}`;
                try { if (id) localStorage.setItem('collapse:'+id, '1'); } catch(e) {}
              }
            } catch(e) {}
            try { const svg = allToggle?.querySelector('.chev'); if (svg) svg.classList.add('rotate-180'); } catch(e) {}
          }
          function expandAlpineSections() {
            const alpSecs = qa('section[x-data]');
            for (const sec of alpSecs) {
              const content = sec.querySelector('[x-show]');
              const toggle = sec.querySelector('[aria-label="Toggle section"]');
              if (!content || !toggle) continue;
              const isOpen = getComputedStyle(content).display !== 'none';
              if (!isOpen) toggle.click();
            }
          }
          function collapseAlpineSections() {
            const alpSecs = qa('section[x-data]');
            for (const sec of alpSecs) {
              const content = sec.querySelector('[x-show]');
              const toggle = sec.querySelector('[aria-label="Toggle section"]');
              if (!content || !toggle) continue;
              const isOpen = getComputedStyle(content).display !== 'none';
              if (isOpen) toggle.click();
            }
          }
          // Single toggle button that expands or collapses everything depending on state
          allToggle?.addEventListener('click', () => {
            const shouldExpand = anyPanelCollapsed();
            if (shouldExpand) expandEverything(); else collapseEverything();
            try { if (allToggle) allToggle.setAttribute('aria-pressed', shouldExpand ? 'true' : 'false'); } catch(e) {}
          });
        })();
        // NOTE: table toggles previously injected into the THEAD caused layout
        // issues. Instead create a small table-expander control inside each
        // panel header (see addPanelExpanderControls below) which will toggle
        // the panel's table TBODY. The logic that manipulates '.table-expander'
        // buttons has been updated to find the table via the panel element.
        // Add per-panel expand/collapse controls that mimic the heuristics panel
        // (toggle visibility of the panel's content and rotate the chevron).
        (function addPanelExpanderControls(){
          function qa(sel){ return Array.from(document.querySelectorAll(sel)); }
          const panels = qa('[data-tabpanel]');
          for (const p of panels) {
            if (!p) continue;
            // Avoid adding controls multiple times
            if (p.querySelector('.panel-expander')) continue;
            // Build header similar to heuristics: left side is empty, right side the toggle
            const header = document.createElement('div');
            header.className = 'flex items-center justify-between px-4 py-3 border-b border-slate-700';
            const title = document.createElement('div');
            title.className = 'text-sm text-slate-300';
            // Use the panel's data-tabpanel as title (Spectral/Redocly)
            const name = p.getAttribute('data-tabpanel') || '';
            title.textContent = name.charAt(0).toUpperCase() + name.slice(1);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 panel-expander';
            btn.setAttribute('aria-expanded', 'true');
            btn.setAttribute('aria-label', 'Toggle section');
            // Use the new stroked chevron icon (matches global buttons)
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="chev h-4 w-4 transition-transform"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>';
            // group controls on the right (only the panel expander button)
            const controls = document.createElement('div');
            controls.className = 'flex items-center gap-2';
            controls.appendChild(btn);
            header.appendChild(title);
            header.appendChild(controls);
            // Insert header before existing panel content
            p.prepend(header);

            // The content is the rest of the panel; find the first child that's not the header
            const content = Array.from(p.children).find(c => c !== header);
            if (!content) continue;
            // Ensure content has padding wrapper like heuristics uses
            content.classList.add('p-4');

            // Restore saved state from localStorage if present for panel expansion
            const id = `panel:${p.getAttribute('data-tabpanel')}`;
            try {
              const saved = localStorage.getItem('collapse:'+id);
              if (saved === '1') {
                content.classList.add('hidden');
                btn.setAttribute('aria-expanded', 'false');
                const che = btn.querySelector('.chev'); if (che) che.classList.add('rotate-180');
              }
            } catch(e) {}

            btn.addEventListener('click', () => {
              const isHidden = content.classList.toggle('hidden');
              btn.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
              const che = btn.querySelector('.chev'); if (che) che.classList.toggle('rotate-180', isHidden);
              try { localStorage.setItem('collapse:'+id, isHidden ? '1' : '0'); } catch(e) {}
            });

            // No separate table toggle: we intentionally avoid injecting controls
            // inside the table header to preserve column layout.
          }
        })();
        
        // Remove any linter panel that doesn't contain any ERROR rows so it doesn't appear.
        (function removeEmptyPanels(){
          const panels = Array.from(document.querySelectorAll('[data-tabpanel]'));
          for (const p of panels) {
            try {
              // Consider the panel empty (do not show) when there are no rows with severity 'error'
              const hasErrorRow = !!p.querySelector("tr.issue-row[data-severity='error'], tr.issue-row[data-severity^='error']");
              if (!hasErrorRow) p.remove();
            } catch(e) {}
          }
        })();
        const genBtn = q('#genPrompt');
        const copyBtn = q('#copyPrompt');
        const copyStatus = q('#copyStatus');
        const boxWrap = q('#promptBoxWrap');
        const box = q('#promptBox');
  const selErrors = q('#selErrors');
  const selWarnings = q('#selWarnings');
  const selAll = q('#selAll');
  const invertSel = q('#invertSel');
  const clearSel = q('#clearSel');
        const incHeur = q('#incHeur');
        // Return all selector checkboxes inside the problems container (both linters)
        const allCbs = () => {
          if (problemsContainer) return Array.from(problemsContainer.querySelectorAll('tr.issue-row input.sel'));
          return qa('tr.issue-row input.sel');
        };

        function updateButtons() {
          const anySelected = allCbs().some(cb => cb.checked);
          genBtn.disabled = !anySelected;
        }

        selErrors?.addEventListener('click', () => {
          const sel = problemsContainer ? "tr.issue-row[data-severity='error'] input.sel" : "tr.issue-row[data-severity='error'] input.sel";
          const list = problemsContainer ? problemsContainer.querySelectorAll(sel) : document.querySelectorAll(sel);
          for (const cb of Array.from(list)) cb.checked = true;
          updateButtons();
        });
        selWarnings?.addEventListener('click', () => {
          // Accept multiple variants used by linters: warn, warning, info etc. We'll match warn* and 'warning'
          const sel = problemsContainer ? "tr.issue-row[data-severity^='warn'] input.sel, tr.issue-row[data-severity='warning'] input.sel" : "tr.issue-row[data-severity^='warn'] input.sel, tr.issue-row[data-severity='warning'] input.sel";
          const list = problemsContainer ? problemsContainer.querySelectorAll(sel) : document.querySelectorAll(sel);
          for (const cb of Array.from(list)) cb.checked = true;
          updateButtons();
        });
        clearSel?.addEventListener('click', () => {
          const list = allCbs();
          for (const cb of list) cb.checked = false;
          updateButtons();
        });

        selAll?.addEventListener('click', () => {
          const list = allCbs();
          for (const cb of list) cb.checked = true;
          updateButtons();
        });
        invertSel?.addEventListener('click', () => {
          const list = allCbs();
          for (const cb of list) cb.checked = !cb.checked;
          updateButtons();
        });

        // Use event delegation to catch changes on any future or current checkboxes inside the problems container
        if (problemsContainer) {
          problemsContainer.addEventListener('change', (ev) => {
            const t = ev.target;
            if (t && t.matches && t.matches('input.sel')) updateButtons();
          });
        } else {
          for (const cb of allCbs()) cb.addEventListener('change', updateButtons);
        }
        // Initial state
        updateButtons();
        // --- Simple client-side pagination for issue tables (Spectral/Redocly) ---
        function setupPagination(containerId, defaultPageSize = 50) {
          const container = document.getElementById(containerId);
          if (!container) return;
          const tbody = container.querySelector('tbody');
          if (!tbody) return;
          const rows = Array.from(tbody.querySelectorAll('tr.issue-row'));
          if (!rows || rows.length === 0) return;

          let pageSize = defaultPageSize;
          let page = 1;
          const totalPages = () => Math.max(1, Math.ceil(rows.length / pageSize));

          const nav = document.createElement('div');
          nav.className = 'mt-3 flex items-center justify-between text-xs text-slate-300';

          const left = document.createElement('div');
          left.className = 'flex items-center gap-2';
          const prev = document.createElement('button');
          prev.textContent = 'Prev';
          prev.className = 'px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 disabled:opacity-50';
          const next = document.createElement('button');
          next.textContent = 'Next';
          next.className = 'px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 disabled:opacity-50';
          const info = document.createElement('span');
          info.className = 'ml-2';
          left.append(prev, next, info);

          const right = document.createElement('div');
          right.className = 'flex items-center gap-2';
          const lab = document.createElement('label');
          lab.textContent = 'Rows/page';
          const sel = document.createElement('select');
          sel.className = 'bg-slate-800 border border-slate-600 rounded px-2 py-1';
          ;[25,50,100,250].forEach(n => { const o=document.createElement('option'); o.value=String(n); o.textContent=String(n); if(n===defaultPageSize) o.selected=true; sel.appendChild(o); });
          right.append(lab, sel);

          nav.append(left, right);

          const panel = container.querySelector('.p-4') || container;
          panel.appendChild(nav);

          function render() {
            const total = totalPages();
            if (page > total) page = total;
            const start = (page - 1) * pageSize;
            const end = Math.min(rows.length, start + pageSize);
            for (let i = 0; i < rows.length; i++) {
              const show = i >= start && i < end;
              rows[i].style.display = show ? '' : 'none';
            }
            info.textContent = `Page ${page} / ${total} — ${rows.length} items`;
            prev.disabled = page <= 1;
            next.disabled = page >= total;
          }

          prev.addEventListener('click', () => { if (page > 1) { page--; render(); } });
          next.addEventListener('click', () => { if (page < totalPages()) { page++; render(); } });
          sel.addEventListener('change', () => { const v = parseInt(sel.value, 10); if (!Number.isNaN(v) && v > 0) { pageSize = v; page = 1; render(); } });

          render();
        }

        // Apply pagination (only if there are rows)
        setupPagination('spectralContent', 50);
        setupPagination('redoclyContent', 50);

        function buildPrompt(){
          // Collect rows from the problems container so we include both Spectral and Redocly selections
          let rows = [];
          try {
            if (problemsContainer) rows = Array.from(problemsContainer.querySelectorAll('tr.issue-row'));
            else rows = qa('tr.issue-row');
          } catch(e) { rows = qa('tr.issue-row'); }
          rows = rows.filter(r => r.querySelector('input.sel')?.checked);
          const dec = (v) => (v ? decodeURIComponent(v) : v);
          const items = rows.map(r => ({
            source: dec(r.dataset.source) || 'spectral',
            severity: dec(r.dataset.severity) || '',
            code: dec(r.dataset.code) || '',
            path: dec(r.dataset.path) || '',
            where: dec(r.dataset.where) || '',
            message: dec(r.dataset.message) || ''
          }));
          const itemLines = items.length
            ? items.map((it, i) => `${i+1}. ${it.severity.toUpperCase()} ${it.code} at ${it.path}${it.where? ' @'+it.where: ''}: ${it.message}`).join('\n')
            : '- No items explicitly selected; suggest general quality improvements.';
          // Read heuristics values from the DOM (server-rendered) to produce concrete heuristics in the prompt
          const getH = (k) => document.querySelector(`[data-heur="${k}"]`)?.textContent?.trim() || '';
          const heurLine = incHeur?.checked
            ? `Heuristics: operations=${getH('operations')}, summaries=${getH('summaryPct')}, descriptions=${getH('descPct')}, has4xx=${getH('with4xxPct')}, opIdUnique=${getH('opIdUniquePct')}, title=${getH('hasTitle')}, version=${getH('hasVersion')}, servers=${getH('hasServers')}, securitySchemes=${getH('hasSecSchemes')}.`
            : '';
          const tpl = document.getElementById('aiPromptTemplate')?.textContent || '';
          return tpl
            .replaceAll('{{HEURISTICS}}', heurLine)
            .replaceAll('{{ITEMS}}', itemLines);
        }

        genBtn?.addEventListener('click', () => {
          const prompt = buildPrompt();
          box.value = prompt;
          boxWrap.classList.remove('hidden');
          copyBtn.disabled = false;
          copyStatus.textContent = '';
        });
        copyBtn?.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(box.value);
            copyStatus.textContent = 'Copied!';
            // Clear prompt after successful copy and hide box
            box.value = '';
            boxWrap.classList.add('hidden');
            copyBtn.disabled = true;
            // Uncheck all selections and update buttons state
            qa('tr.issue-row input.sel').forEach(cb => cb.checked = false);
            updateButtons();
          } catch {
            copyStatus.textContent = 'Copy failed';
          }
          setTimeout(() => (copyStatus.textContent = ''), 2000);
        });
        })();
        // Redocly toggle handled via Alpine in the summary card; no imperative logic needed here.
      </script>
    <footer class="mt-10 text-center text-xs text-slate-500">
      Generated by Zoomiit © {{year}}
    </footer>
  </body>
</html>
<!-- Toast notification (Alpine store: $store.toast) -->
<div x-data class="fixed top-4 right-4 z-50" x-show="$store.toast.show" x-transition.opacity>
  <div class="bg-slate-800/90 border border-slate-700 text-slate-100 rounded px-3 py-2 shadow-lg">
    <span x-text="$store.toast.message"></span>
  </div>
</div>
